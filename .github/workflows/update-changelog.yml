# Action to update repository changelog.
name: Update Changelog

permissions:
  contents: write

on:
  pull_request:
    branches:
      - main

jobs:
  changelog:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Install dependencies
        run: npm i conventional-changelog-cli
        working-directory: ./demo
      
      - run: |
          # Initialize CHANGELOG.md if it doesn't exist
          if [ ! -f ../CHANGELOG.md ]; then
            echo "# Changelog" > ../CHANGELOG.md
            git config user.name "GitHub Actions"
            git config user.email "actions@github.com"
            git add ../CHANGELOG.md
            git commit -m "docs(changelog): initialize changelog #4" || true
          fi

          # Compare against target branch
          git fetch origin main
          npx conventional-changelog -p angular \
            -i ../CHANGELOG.md \
            -s \
            --context . \
            -r 0 \
            --release-count 1 \
            --output-unreleased
        working-directory: ./demo